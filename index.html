<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>סוכן חכם של גיא</title>
  <style>
    body {
      background: radial-gradient(circle at top, #0f2027, #203a43, #2c5364);
      font-family: 'Segoe UI', sans-serif;
      color: #fff;
      text-align: center;
      padding: 2rem;
    }
    h1 {
      font-size: 3rem;
      color: #00fff7;
    }
    input[type="file"], input[type="text"], button {
      margin: 1rem;
      padding: 0.8rem 1.2rem;
      border-radius: 1rem;
      border: none;
      font-size: 1.1rem;
    }
    #recordButton {
      background: linear-gradient(45deg, #00f2fe, #4facfe);
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    #recordButton.recording {
      background: red;
      color: white;
    }
    button:hover {
      opacity: 0.8;
    }
    #response {
      margin-top: 2rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      font-size: 1.2rem;
      max-width: 700px;
      margin-inline: auto;
    }
  </style>
</head>
<body>
  <h1>ברוך הבא לסוכן הבינה של גיא</h1>
  <input type="file" id="pdfUpload" accept="application/pdf" />
  <br>
  <button id="recordButton">🎙️ לחץ ודבר</button>
  <br>
  <input type="text" id="userInput" placeholder="שאל שאלה בעברית או אנגלית" />
  <button onclick="askAgent()">שאל את גיא</button>
  <div id="response"></div>

  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
  <script>
    let pdfText = "";
    let isRecording = false;

    document.getElementById('pdfUpload').addEventListener('change', async function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async function () {
          const typedarray = new Uint8Array(this.result);
          const pdf = await pdfjsLib.getDocument(typedarray).promise;
          let fullText = '';
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            fullText += content.items.map(item => item.str).join(' ') + '\n';
          }
          pdfText = fullText;
          alert("📄 הקובץ הועלה בהצלחה!");
        };
        reader.readAsArrayBuffer(file);
      }
    });

    async function askAgent() {
      const input = document.getElementById('userInput').value.trim();
      if (!input) return;

      const prompt = pdfText
        ? `שאלה: ${input}\n\nמסמך מצורף:\n${pdfText}`
        : input;

      try {
        const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer or-v1-a26d99f66a920a6acdbc66d281bfbc5b09b3151eb05d1771fa89378f728d0f2e"
          },
          body: JSON.stringify({
            model: "openai/gpt-3.5-turbo",
            messages: [
              {
                role: "system",
                content: `אתה עוזר אישי חכם בשם גיא. דבר עם המשתמש בעברית או אנגלית לפי מה שהוא מדבר. אתה מומחה בדיני עסקים, חוזים, פתיחת חברות, מיסוי אמריקאי, רגולציות של SEC, דיני תאגידים בארה״ב ודיני ניירות ערך. ענה באופן משפטי מדויק וברור, ובמיוחד על מסמכים או שאלות עסקיות. תנתח מסמכים משפטיים ותסביר בשפה פשוטה.`
              },
              { role: "user", content: prompt }
            ]
          })
        });

        const data = await res.json();
        const reply = data.choices?.[0]?.message?.content || "⚠️ לא התקבלה תשובה.";
        document.getElementById("response").textContent = reply;

        const speech = new SpeechSynthesisUtterance(reply);
        speech.lang = /[\u0590-\u05FF]/.test(reply) ? 'he-IL' : 'en-US';
        speechSynthesis.speak(speech);
      } catch (e) {
        document.getElementById("response").textContent = "⚠️ שגיאה: " + e.message;
      }
    }

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'he-IL';

    const recordButton = document.getElementById('recordButton');
    function startListening() {
      isRecording = true;
      recordButton.classList.add('recording');
      recognition.start();
    }

    function stopListening() {
      if (isRecording) {
        recognition.stop();
        recordButton.classList.remove('recording');
        isRecording = false;
      }
    }

    recordButton.addEventListener('mousedown', startListening);
    recordButton.addEventListener('mouseup', stopListening);
    recordButton.addEventListener('touchstart', startListening);
    recordButton.addEventListener('touchend', stopListening);

    recognition.onresult = (e) => {
      const transcript = e.results[0][0].transcript;
      document.getElementById('userInput').value = transcript;
      askAgent();
    };

    recognition.onerror = (e) => {
      document.getElementById("response").textContent = "⚠️ שגיאת קול: " + e.error;
    };
  </script>
</body>
</html>
